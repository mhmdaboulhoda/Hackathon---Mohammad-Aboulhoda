<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Breast Cancer Diagnosis Assistant</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <style>
        body { padding-top: 2rem; transition: background-color 0.3s ease, color 0.3s ease; }
        .feature-input { margin-bottom: 1rem; }
        .filter-input { margin-bottom: 0.5rem; }
        .card { margin-bottom: 2rem; transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease; }
        .table-responsive { max-height: 400px; }
        body.dark-mode { background-color: #121212; color: #f1f1f1; }
        body.dark-mode .card { background-color: #1e1e1e; color: #f1f1f1; border-color: #2a2a2a; }
        body.dark-mode .table { color: #f1f1f1; background-color: #121212; }
        body.dark-mode .table thead th { color: #ffffff; background-color: #1f1f1f; border-color: #333; }
        body.dark-mode .table tbody td { color: #f8f9fa; background-color: #181818; border-color: #2a2a2a; }
        body.dark-mode .table-striped tbody tr:nth-of-type(odd) { background-color: #1f1f1f; color: #f8f9fa; }
        body.dark-mode .table-striped tbody tr:nth-of-type(even) { background-color: #181818; color: #f8f9fa; }
        body.dark-mode .table tbody tr:hover { background-color: #232323; }
        body.dark-mode .form-control { background-color: #2a2a2a; color: #f1f1f1; border-color: #3a3a3a; }
        body.dark-mode .form-control:focus { background-color: #2f2f2f; color: #fff; border-color: #5c7cfa; box-shadow: none; }
        body.dark-mode .form-control.is-invalid { border-color: #ff6b6b; }
        body.dark-mode .form-control.is-valid { border-color: #51cf66; }
        body.dark-mode .text-muted { color: rgba(255,255,255,0.75)!important; }
        body.dark-mode .alert-info { background-color: rgba(13,110,253,0.1); color: #cfe2ff; border-color: rgba(13,110,253,0.2); }
        body.dark-mode .nav-tabs .nav-link.active { background-color: #1e1e1e; border-color: #2a2a2a; color: #f1f1f1; }
        body.dark-mode .nav-tabs .nav-link { color: #dee2e6; }
    </style>
</head>
<body>
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="mb-0">Breast Cancer Diagnosis Assistant</h1>
        <button type="button" id="theme-toggle" class="btn btn-outline-dark btn-sm">Dark Mode</button>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }}" role="alert">
            {{ message }}
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <ul class="nav nav-tabs mb-4">
        <li class="nav-item">
            <a class="nav-link {% if active_tab == 'diagnosis' %}active{% endif %}" href="{{ url_for('index', tab='diagnosis') }}">Diagnosis</a>
        </li>
        <li class="nav-item">
            <a class="nav-link {% if active_tab == 'records' %}active{% endif %}" href="{{ url_for('index', tab='records') }}">Records</a>
        </li>
    </ul>

    {% if active_tab == 'diagnosis' %}
    <form method="post" id="diagnosis-form">
        <input type="hidden" name="tab" value="diagnosis">
        <div class="alert alert-info" role="alert">
            Enter positive numeric values for all features.
        </div>

        <div class="card">
            <div class="card-header">Patient Features</div>
            <div class="card-body">
                <div class="row">
                    {% for feature in features %}
                    <div class="col-md-4">
                        <div class="feature-input">
                            <label class="form-label" for="{{ feature.name }}">{{ feature.label }}</label>
                            <input 
                                type="text"
                                class="form-control {% if diagnosis_errors.get(feature.name) %}is-invalid{% elif diagnosis_values.get(feature.name) %}is-valid{% endif %}"
                                id="{{ feature.name }}"
                                name="{{ feature.name }}"
                                value="{{ diagnosis_values.get(feature.name, '') }}"
                                required>
                            {% if diagnosis_errors.get(feature.name) %}
                            <div class="invalid-feedback">{{ diagnosis_errors.get(feature.name) }}</div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <button type="submit" name="predict" class="btn btn-primary">Predict Diagnosis</button>
                <button type="button" id="reset-patient" class="btn btn-primary ms-2">Reset Patient Form</button>
            </div>
        </div>
    </form>

    {% if prediction %}
    <div class="card">
        <div class="card-header">Prediction Result</div>
        <div class="card-body">
            <h5>Diagnosis: <span class="badge bg-{{ 'danger' if prediction['label'] == 'Malignant' else 'success' }}">{{ prediction['label'] }}</span></h5>
            <p>Probability of malignancy: {{ (prediction['probability'] * 100)|round(2) }}%</p>
        </div>
    </div>
    {% endif %}

    {% elif active_tab == 'records' %}
    <form method="post" id="records-form" class="mb-4">
        <input type="hidden" name="tab" value="records">
        <div class="card">
            <div class="card-header">Filter Saved Records</div>
            <div class="card-body">
                <p class="text-muted">Use operators (&gt;, &gt;=, &lt;, &lt;=, ==). Example: <code>&gt;=3</code>, <code>&lt;5.5</code></p>
                <div class="row">
                    {% for feature in features %}
                    <div class="col-md-4">
                        <div class="filter-input">
                            <label class="form-label" for="filter_{{ feature.name }}">{{ feature.label }} Filter</label>
                            <input 
                                type="text"
                                class="form-control {% if filter_errors.get(feature.name) %}is-invalid{% endif %}"
                                id="filter_{{ feature.name }}"
                                name="filter_{{ feature.name }}"
                                value="{{ filter_values.get('filter_' + feature.name, '') }}"
                                data-server-error="{{ filter_errors.get(feature.name, '') }}">
                            <div class="invalid-feedback">{{ filter_errors.get(feature.name) }}</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <button type="submit" name="filter" class="btn btn-primary">Apply Filters</button>
                <button type="button" id="reset-filters" class="btn btn-primary ms-2">Reset Filters</button>
            </div>
        </div>
    </form>

    <div class="card">
        <div class="card-header">Saved Patient Records ({{ total_records }})</div>
        <div class="card-body table-responsive">
            {% if records %}
            <table class="table table-striped table-sm">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Prediction</th>
                        <th>Malignancy %</th>
                        {% for feature in features %}
                        <th>{{ feature.label }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for row in records %}
                    <tr>
                        <td>{{ loop.index }}</td>
                        <td>
                            <span class="badge bg-{{ 'danger' if row['prediction'] == 'Malignant' else 'success' }}">{{ row['prediction'] }}</span>
                        </td>
                        <td>{{ (row['probability'] * 100)|round(2) }}%</td>
                        {% for feature in features %}
                        <td>{{ row[feature.name] }}</td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p class="text-muted mb-0">No records saved yet. Run a prediction to add one.</p>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>
<script>
  (function() {
    const diagnosisForm = document.getElementById('diagnosis-form');
    const recordsForm = document.getElementById('records-form');

    const patientBtn = document.getElementById('reset-patient');
    if (patientBtn && diagnosisForm) {
      patientBtn.addEventListener('click', function () {
        const inputs = diagnosisForm.querySelectorAll('input[name]:not([type="hidden"])');
        inputs.forEach(function(input) {
          input.value = '';
          input.classList.remove('is-valid', 'is-invalid');
        });
      });
    }

    const filterBtn = document.getElementById('reset-filters');
    if (filterBtn && recordsForm) {
      filterBtn.addEventListener('click', function () {
        const inputs = recordsForm.querySelectorAll('input[name^="filter_"]');
        inputs.forEach(function(input) {
          input.value = '';
          input.classList.remove('is-valid', 'is-invalid');
          const feedback = input.nextElementSibling;
          if (feedback && feedback.classList.contains('invalid-feedback')) {
            feedback.textContent = '';
          }
          input.removeAttribute('data-server-error');
        });
      });
    }

    const themeToggle = document.getElementById('theme-toggle');
    const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    const storedTheme = localStorage.getItem('theme') || (prefersDark ? 'dark' : 'light');

    function applyTheme(theme) {
      const body = document.body;
      if (theme === 'dark') {
        body.classList.add('dark-mode');
        themeToggle.textContent = 'Light Mode';
        themeToggle.classList.remove('btn-outline-dark');
        themeToggle.classList.add('btn-outline-light');
      } else {
        body.classList.remove('dark-mode');
        themeToggle.textContent = 'Dark Mode';
        themeToggle.classList.remove('btn-outline-light');
        themeToggle.classList.add('btn-outline-dark');
      }
    }

    applyTheme(storedTheme);

    if (themeToggle) {
      themeToggle.addEventListener('click', function () {
        const newTheme = document.body.classList.contains('dark-mode') ? 'light' : 'dark';
        applyTheme(newTheme);
        localStorage.setItem('theme', newTheme);
      });
    }

    function updateFieldState(input) {
      const value = input.value.trim();
      if (!value) {
        input.classList.remove('is-valid', 'is-invalid');
        return;
      }
      const parsed = Number(value);
      if (!Number.isFinite(parsed) || parsed <= 0) {
        input.classList.remove('is-valid');
        input.classList.add('is-invalid');
      } else {
        input.classList.remove('is-invalid');
        input.classList.add('is-valid');
      }
    }

    const filterAllowedOps = ['>=', '<=', '==', '>', '<'];

    function updateFilterState(input) {
      const feedback = input.nextElementSibling;
      const serverError = input.getAttribute('data-server-error');
      input.classList.remove('is-valid', 'is-invalid');
      if (feedback && feedback.classList.contains('invalid-feedback')) {
        feedback.textContent = '';
      }
      if (serverError) {
        input.classList.add('is-invalid');
        if (feedback && feedback.classList.contains('invalid-feedback')) {
          feedback.textContent = serverError;
        }
        return;
      }

      const value = input.value.trim();
      if (!value) {
        return;
      }
      const op = filterAllowedOps.find(op => value.startsWith(op));
      if (!op) {
        input.classList.add('is-invalid');
        if (feedback && feedback.classList.contains('invalid-feedback')) {
          feedback.textContent = 'Start with >, >=, <, <=, or ==';
        }
        return;
      }
      const numberPart = value.slice(op.length).trim();
      if (!numberPart) {
        input.classList.add('is-invalid');
        if (feedback && feedback.classList.contains('invalid-feedback')) {
          feedback.textContent = 'Provide a numeric value after the operator.';
        }
        return;
      }
      const parsed = Number(numberPart);
      if (!Number.isFinite(parsed)) {
        input.classList.add('is-invalid');
        if (feedback && feedback.classList.contains('invalid-feedback')) {
          feedback.textContent = 'Provide a numeric value after the operator.';
        }
        return;
      }
      input.classList.add('is-valid');
    }

    if (diagnosisForm) {
      const inputs = diagnosisForm.querySelectorAll('input[name]:not([type="hidden"])');
      inputs.forEach(function(input) {
        input.addEventListener('input', function () {
          updateFieldState(input);
        });
        input.addEventListener('blur', function () {
          updateFieldState(input);
        });
        updateFieldState(input);
      });
    }

    if (recordsForm) {
      const inputs = recordsForm.querySelectorAll('input[name^="filter_"]');
      inputs.forEach(function(input) {
        input.addEventListener('input', function () {
          input.removeAttribute('data-server-error');
          updateFilterState(input);
        });
        input.addEventListener('blur', function () {
          updateFilterState(input);
        });
        updateFilterState(input);
      });
    }
  })();
</script>
</body>
</html>
