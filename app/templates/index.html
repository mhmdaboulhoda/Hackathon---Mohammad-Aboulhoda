<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Breast Cancer Diagnosis Assistant</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <style>
        body { padding-top: 2rem; }
        .feature-input { margin-bottom: 1rem; }
        .filter-input { margin-bottom: 0.5rem; }
        .card { margin-bottom: 2rem; }
        .table-responsive { max-height: 400px; }
    </style>
</head>
<body>
<div class="container">
    <h1 class="mb-4">Breast Cancer Diagnosis Assistant</h1>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }}" role="alert">
            {{ message }}
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <ul class="nav nav-tabs mb-4">
        <li class="nav-item">
            <a class="nav-link {% if active_tab == 'diagnosis' %}active{% endif %}" href="{{ url_for('index', tab='diagnosis') }}">Diagnosis</a>
        </li>
        <li class="nav-item">
            <a class="nav-link {% if active_tab == 'records' %}active{% endif %}" href="{{ url_for('index', tab='records') }}">Records</a>
        </li>
    </ul>

    {% if active_tab == 'diagnosis' %}
    <form method="post" id="diagnosis-form">
        <input type="hidden" name="tab" value="diagnosis">
        <div class="alert alert-info" role="alert">
            Enter positive numeric values for all features.
        </div>

        <div class="card">
            <div class="card-header">Patient Features</div>
            <div class="card-body">
                <div class="row">
                    {% for feature in features %}
                    <div class="col-md-4">
                        <div class="feature-input">
                            <label class="form-label" for="{{ feature.name }}">{{ feature.label }}</label>
                            <input 
                                type="text"
                                class="form-control"
                                id="{{ feature.name }}"
                                name="{{ feature.name }}"
                                required>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <button type="submit" name="predict" class="btn btn-primary">Predict Diagnosis</button>
                <button type="button" id="reset-patient" class="btn btn-outline-secondary ms-2">Reset Patient Form</button>
            </div>
        </div>
    </form>

    {% if prediction %}
    <div class="card">
        <div class="card-header">Prediction Result</div>
        <div class="card-body">
            <h5>Diagnosis: <span class="badge bg-{{ 'danger' if prediction['label'] == 'Malignant' else 'success' }}">{{ prediction['label'] }}</span></h5>
            <p>Probability of malignancy: {{ (prediction['probability'] * 100)|round(2) }}%</p>
        </div>
    </div>
    {% endif %}

    {% elif active_tab == 'records' %}
    <form method="post" id="records-form" class="mb-4">
        <input type="hidden" name="tab" value="records">
        <div class="card">
            <div class="card-header">Filter Saved Records</div>
            <div class="card-body">
                <p class="text-muted">Use operators (&gt;, &gt;=, &lt;, &lt;=, ==). Example: <code>&gt;=3</code>, <code>&lt;5.5</code></p>
                <div class="row">
                    {% for feature in features %}
                    <div class="col-md-4">
                        <div class="filter-input">
                            <label class="form-label" for="filter_{{ feature.name }}">{{ feature.label }} Filter</label>
                            <input 
                                type="text"
                                class="form-control"
                                id="filter_{{ feature.name }}"
                                name="filter_{{ feature.name }}">
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <button type="submit" name="filter" class="btn btn-secondary">Apply Filters</button>
                <button type="button" id="reset-filters" class="btn btn-outline-secondary ms-2">Reset Filters</button>
            </div>
        </div>
    </form>

    <div class="card">
        <div class="card-header">Saved Patient Records ({{ total_records }})</div>
        <div class="card-body table-responsive">
            {% if records %}
            <table class="table table-striped table-sm">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Prediction</th>
                        <th>Malignancy %</th>
                        {% for feature in features %}
                        <th>{{ feature.label }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for row in records %}
                    <tr>
                        <td>{{ loop.index }}</td>
                        <td>
                            <span class="badge bg-{{ 'danger' if row['prediction'] == 'Malignant' else 'success' }}">{{ row['prediction'] }}</span>
                        </td>
                        <td>{{ (row['probability'] * 100)|round(2) }}%</td>
                        {% for feature in features %}
                        <td>{{ row[feature.name] }}</td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p class="text-muted mb-0">No records saved yet. Run a prediction to add one.</p>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>
<script>
  (function() {
    const diagnosisForm = document.getElementById('diagnosis-form');
    const recordsForm = document.getElementById('records-form');

    const patientBtn = document.getElementById('reset-patient');
    if (patientBtn && diagnosisForm) {
      patientBtn.addEventListener('click', function () {
        const inputs = diagnosisForm.querySelectorAll('input[name]:not([type="hidden"])');
        inputs.forEach(function(input) {
          input.value = '';
        });
      });
    }

    const filterBtn = document.getElementById('reset-filters');
    if (filterBtn && recordsForm) {
      filterBtn.addEventListener('click', function () {
        const inputs = recordsForm.querySelectorAll('input[name^="filter_"]');
        inputs.forEach(function(input) {
          input.value = '';
        });
      });
    }
  })();
</script>
</body>
</html>
